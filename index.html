<!DOCTYPE html>
<html>
    <head>
	<link rel="stylesheet" href="js/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" href="js/bootstrap/css/bootstrap-responsive.css">
	<title>Scheduler</title>
	<style type="text/css">
	    body {
		padding: 5px;
	    }
	    a {
		cursor: pointer;
	    }
	    .available {
		color: green;
	    }
	    .unavailable {
		color: red;
	    }
	    .final {
		color: blue;
	    }
	    div#table-wrapper {
	      overflow: auto;
	    }
	    table#schedule {
	      table-layout: fixed;
	      width: 1000px;
	    }
	</style>
    </head>
    <body>
	<div class="container-fluid">
	    <div class="row-fluid">
		<div id="table-wrapper" class="span9">
		    <table id="schedule" class="table table-bordered">
			<thead>
			    <tr>
				<th>Times</th>
				<th>Monday</th>
				<th>Tuesday</th>
				<th>Wednesday</th>
				<th>Thursday</th>
				<th>Friday</th>
			    </tr>
			</thead>
			<tbody>
			    <tr id="800">
				<td>8:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="900">
				<td>9:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1000">
				<td>10:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1100">
				<td>11:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1200">
				<td>12:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1300">
				<td>1:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1400">
				<td>2:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1500">
				<td>3:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1600">
				<td>4:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1700">
				<td>5:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1800">
				<td>6:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1900">
				<td>7:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2000">
				<td>8:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2100">
				<td>9:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2200">
				<td>10:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			</tbody>
		    </table>
		</div>
		<div class="span3 well">
		    <a data-toggle="collapse" data-target="#createTimeslotAccordion">
			Create Timeslot
		    </a>
		    <div id="createTimeslotAccordion" class="collapse">
			<input type="text" id="timeslot-name" placeholder="Name" />
			<select id="timeslot-time">
			  <option value="800">8:00am</option>
			  <option value="900">9:00am</option>
			  <option value="1000">10:00am</option>
			  <option value="1100">11:00am</option>
			  <option value="1200">12:00pm</option>
			  <option value="1300">1:00pm</option>
			  <option value="1400">2:00pm</option>
			  <option value="1500">3:00pm</option>
			  <option value="1600">4:00pm</option>
			  <option value="1700">5:00pm</option>
			  <option value="1800">6:00pm</option>
			  <option value="1900">7:00pm</option>
			  <option value="2000">8:00pm</option>
			  <option value="2100">9:00pm</option>
			  <option value="2200">10:00pm</option>
			</select>
			<select id="timeslot-day">
			    <option val="Monday">Monday</option>
			    <option val="Tuesday">Tuesday</option>
			    <option val="Wednesday">Wednesday</option>
			    <option val="Thursday">Thursday</option>
			    <option val="Friday">Friday</option>
			</select>
			<button type="button" id="create-timeslot" class="btn btn-primary">Create Timeslot</button>
		    </div>
		    <a data-toggle="collapse" data-target="#createWorkerAccordion">
			Create Worker
		    </a>
		    <div id="createWorkerAccordion" class="collapse">
			<input type="text" id="worker-name" placeholder="Name" />
			<button type="button" id="create-worker" class="btn btn-primary">Create Worker</button>
		    </div>
		    <hr>
		    <div id="workerDiv">
		      <h5>Worker List</h5>
		    </div>
		    <div id="timeslot-info" class="collapse">
		      <hr>
		      <h4 id="timeslot-info-name"></h4>
		      <select id="timeslot-info-select"></select>
		      <button type="button" class="btn btn-primary" id="choose-worker">Choose Worker</button>
		    </div>
		</div>
	    </div>
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
	<script src="js/bootstrap/js/bootstrap.js"></script>
	<script src="js/Timeslot.js"></script>
	<script src="js/Worker.js"></script>
	<script type="text/javascript">

	    /*TODO:
	      - drag workers to timeslot in sidebar? so it's not so far to drag
	      - if worker is already final, and you add them to a new timeslot,
		they are available in the new timeslot
	      - delete worker functionality
	      - timeslots of different length
	      - timeslots starting and ending at different points
	      - add all workers to all timeslots
	      - setup page?
	      - export to excel?
	    */
	    
	    //Overwrite Array remove
	    Array.prototype.remove = function(from, to) {
		var rest = this.slice((to || from) + 1 || this.length);
		this.length = from < 0 ? this.length + from : from;
		return this.push.apply(this, rest);
	    };
	    
	    //Timeslot List
	    var timeslotList = new Array();
	    //Worker List
	    var workerList = new Array();
	    
	    $(document).ready(function() {
		$("button#create-timeslot").click(function() {
		    var name = $("input#timeslot-name").val().replace(/ /g, "_");
		    //Prevent duplicates
		    if (!find(timeslotList, name)) {
		      var time = $("select#timeslot-time").val();
		      var day = $("select#timeslot-day option:selected").val();
		      createTimeslot(time, day, name);
		    }
		});

		$("button#create-worker").click(function() {
		    var name = $("input#worker-name").val().replace(/ /g, "_");
		    //Prevent duplicates
		    if (!find(workerList, name)) {
		      var s = new Worker(name);
		      workerList.push(s);
		      var workerAlert = "<span>" + name + " </span>";
		      var clone = $(workerAlert).clone();
		      $(clone).draggable({
			  revert: true,
			  cursor: "move"
		      });
		      $("#workerDiv").append(clone);
		    }
		});

		$("button#choose-worker").click(function() {
		    //Add Worker as final
		    var timeslotName = $("#timeslot-info-name").text();
		    var workerName = $("#timeslot-info-select option:selected").val();
		    //Find them in their arrays
		    var timeslot = find(timeslotList, timeslotName);
		    var worker = find(workerList, workerName);
		    var oldFinalWorker = timeslot.getFinalWorker();
		    //Set objects
		    if (workerName != "--None--") {
		      worker.setIsFinal(true);
		      if (oldFinalWorker) {
			oldFinalWorker.setIsFinal(false);
		      }
		      timeslot.setFinalWorker(worker);
		    } else {
		      if (oldFinalWorker) {
			oldFinalWorker.setIsFinal(false);
		      }
		      timeslot.setFinalWorker(null);
		    }
		    //Reset everyone to available
		    reset();
		    //Iterate through all workers, if they are final, set all spans
		    //to unavailable
		    for (var i = 0; i < workerList.length; i++) {
		      var worker = workerList[i];
		      console.log(worker);
		      if (worker.isFinal) {
			$.each($("span." + worker.name), function() {
			  $(this).attr('class', worker.name);
			  $(this).addClass('unavailable');
			});
		      }
		    }
		    //Iterate through all timeslots, if they have a final,
		    //set that worker to final, and set everyone else to unavailable
		    for (var i = 0; i < timeslotList.length; i++) {
		      var timeslot = timeslotList[i];
		      if (timeslot.getFinalWorker()) {
			var spans = $("div#" + timeslot.name + " > div.workers > span");
			$.each(spans, function() { 
			  if ($(this).text().trim() == timeslot.getFinalWorker().name) {
			    $(this).attr('class', $(this).text().trim());
			    $(this).addClass('final');
			  } else {
			    $(this).attr('class', $(this).text().trim());
			    $(this).addClass('unavailable');
			  }
			});
		      }
		    }

		});

		$(document).on('click', 'button.close', function() {
		    //Delete timeslot
		    var name = $(this).parent().attr('id');
		    for (var i = 0; i < timeslotList.length; i++) {
			if (timeslotList[i].name == name) {
			    timeslotList.remove(i);
			}
		    }
		    $(this).parent().remove(); 
		});

	    });

	    /** Functions **/

	    function reset() {
	      //Iterate through all worker spans and set them to available
	      $.each($("div.workers > span"), function() {
		$(this).attr('class', $(this).text().trim());
		$(this).addClass('available');
	      });
	    }

	    function find(list, name) {
	      for (var i = 0; i < list.length; i++) {
		if (name == list[i].name) {
		  return list[i];
		}
	      }
	      return null;
	    }

	    function createTimeslot(time, day, name) {
		var s = new Timeslot(time, day, name);
		timeslotList.push(s);
		var timeslotDiv = "<div id='" + name + "' class='alert'><button type='button' class='close'>&times;</button><a onclick='timeslotInfo(this)'>" + name + "</a><div class='workers'></div></div>";
		var clone = $(timeslotDiv).clone();
		$(clone).droppable({
		    hoverClass: "alert-success",
		    drop: function(event, ui) {
			//TODO: prevent duplicates when dropping
			$(this).find("div.workers").append("<span class='available " + $(ui.draggable).text().trim() + "'>" + $(ui.draggable).text() + "</span>");
			var index = timeslotList.indexOf(s);
			timeslotList[index].addPossibleWorker($(ui.draggable).text().trim());
		      }
		});
		$("table#schedule tbody tr#" + time).find("#" + day).append(clone);
	    }

	    function timeslotInfo(link) {
		//Show timeslot info
		var div = $(link).parent();
		//Empty the select
		$("#timeslot-info-select").empty();
		//Add 'None' option 
		$('#timeslot-info-select').append("<option value='none'>--None--</option>");
		$.each($(div).find('span'), function() {
		    $("#timeslot-info-select").append("<option value='" + $(this).text().trim() + "'>" + $(this).text().trim() + "</option>");
		});
		var timeslotName = $(div).find('a').text();
		var timeslot = find(timeslotList, timeslotName);
		if (timeslot.getFinalWorker() == null) {
		  $("#timeslot-info-select").val('none');
		} else {
		  $("#timeslot-info-select").val(timeslot.getFinalWorker().name);
		}
		$("#timeslot-info-name").text(timeslotName);
		//Show info div
		$("#timeslot-info").collapse('show');

	    }

	</script>
    </body>
</html>
