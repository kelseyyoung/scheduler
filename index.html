<!DOCTYPE html>
<html>
    <head>
	<link rel="stylesheet" href="js/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" href="js/bootstrap/css/bootstrap-responsive.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.css">
	<title>Scheduler</title>
	<style type="text/css">
	    body {
		padding: 5px;
	    }
	    a {
		cursor: pointer;
	    }
	    .available {
		color: green;
	    }
	    .unavailable {
		color: red;
	    }
	    .final {
		color: blue;
	    }
	    div#table-wrapper {
	      overflow: auto;
	    }
	    table#schedule {
	      table-layout: fixed;
	      width: 1000px;
	    }
	    div.well.well-small.no-margin {
	      margin: 0px;
	    }
	    span.label > button.close {
	      line-height: 14px;
	      margin-top: -3px;
	    }
	</style>
    </head>
    <body>
	<div class="container-fluid">
	    <div class="row-fluid">
		<div id="table-wrapper" class="span9">
		    <table id="schedule" class="table table-bordered">
			<thead>
			    <tr>
				<th>Times</th>
				<th>Monday</th>
				<th>Tuesday</th>
				<th>Wednesday</th>
				<th>Thursday</th>
				<th>Friday</th>
			    </tr>
			</thead>
			<tbody>
			    <tr id="800">
				<td>8:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="900">
				<td>9:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1000">
				<td>10:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1100">
				<td>11:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1200">
				<td>12:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1300">
				<td>1:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1400">
				<td>2:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1500">
				<td>3:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1600">
				<td>4:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1700">
				<td>5:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1800">
				<td>6:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="1900">
				<td>7:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2000">
				<td>8:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2100">
				<td>9:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			    <tr id="2200">
				<td>10:00</td>
				<td id="Monday"></td>
				<td id="Tuesday"></td>
				<td id="Wednesday"></td>
				<td id="Thursday"></td>
				<td id="Friday"></td>
			    </tr>
			</tbody>
		    </table>
		</div>
		<div class="span3 well well-small">
		  <div class="well well-small no-margin">
		    <a data-toggle="collapse" class="caret-change" data-target="#createTimeslotAccordion">
			Create Timeslot
			<i class="pull-right icon-caret-right"></i>
		    </a>
		    <div id="createTimeslotAccordion" class="collapse">
			<input type="text" class="span10" id="timeslot-name" placeholder="Name" />
			<select class="span10" id="timeslot-time">
			  <option value="800">8:00am</option>
			  <option value="900">9:00am</option>
			  <option value="1000">10:00am</option>
			  <option value="1100">11:00am</option>
			  <option value="1200">12:00pm</option>
			  <option value="1300">1:00pm</option>
			  <option value="1400">2:00pm</option>
			  <option value="1500">3:00pm</option>
			  <option value="1600">4:00pm</option>
			  <option value="1700">5:00pm</option>
			  <option value="1800">6:00pm</option>
			  <option value="1900">7:00pm</option>
			  <option value="2000">8:00pm</option>
			  <option value="2100">9:00pm</option>
			  <option value="2200">10:00pm</option>
			</select>
			<select class="span10" id="timeslot-day">
			    <option val="Monday">Monday</option>
			    <option val="Tuesday">Tuesday</option>
			    <option val="Wednesday">Wednesday</option>
			    <option val="Thursday">Thursday</option>
			    <option val="Friday">Friday</option>
			</select>
			<button type="button" id="create-timeslot" class="btn btn-primary">Create Timeslot</button>
		    </div>
		  </div>
		    <div class="well well-small">
		    <a data-toggle="collapse" class="caret-change" data-target="#createWorkerAccordion">
			Create Worker
			<i class="pull-right icon-caret-right"></i>
		    </a>
		    <div id="createWorkerAccordion" class="collapse">
			<input type="text" class="span10" id="worker-name" placeholder="Name" />
			<button type="button" id="create-worker" class="btn btn-primary">Create Worker</button>
		    </div>
		    </div>
		    <hr>
		    <div id="workerDiv">
		      <button type="button" class="btn btn-mini pull-right" onclick="addAll();">Add All</button>
		      <h5>Worker List</h5>
		    </div>
		    <div id="timeslot-info" class="collapse">
		      <hr>
		      <h4 id="timeslot-info-name"></h4>
		      <select id="timeslot-info-select"></select>
		      <button type="button" class="btn btn-primary" id="choose-worker">Choose Worker</button>
		      <button type="button" class="btn btn-danger" id="delete-worker">Delete Worker</button>
		    </div>
		</div>
	    </div>
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
	<script src="js/bootstrap/js/bootstrap.js"></script>
	<script src="js/Timeslot.js"></script>
	<script src="js/Worker.js"></script>
	<script type="text/javascript">

	    /*TODO:
	      - drag workers to timeslot in sidebar? so it's not so far to drag
	      - BUG: if worker is already final, and you add them to a new timeslot,
		they are available in the new timeslot
	      - BUG: if drag and drop all, then click add all, huge error
	      - timeslots of different length
	      - timeslots starting and ending at different points
	      - setup page?
	      - export to excel?
	    */
	    
	    //Overwrite Array remove
	    Array.prototype.remove = function(from, to) {
		var rest = this.slice((to || from) + 1 || this.length);
		this.length = from < 0 ? this.length + from : from;
		return this.push.apply(this, rest);
	    };
	    
	    //Timeslot List
	    var timeslotList = new Array();
	    //Worker List
	    var workerList = new Array();
	    
	    $(document).ready(function() {

		$(".caret-change").on('click', function() {
		  var icon = $(this).find('i');
		  if ($(icon).hasClass("icon-caret-right")) {
		    $(icon).removeClass("icon-caret-right");
		    $(icon).addClass("icon-caret-down");
		  } else {
		    $(icon).removeClass("icon-caret-down");
		    $(icon).addClass("icon-caret-right");
		  }
		});

		$("button#create-timeslot").click(function() {
		    var name = $("input#timeslot-name").val().replace(/ /g, "_");
		    //Prevent duplicates
		    if (!find(timeslotList, name)) {
		      var time = $("select#timeslot-time").val();
		      var day = $("select#timeslot-day option:selected").val();
		      createTimeslot(time, day, name);
		    }
		});

		$("button#create-worker").click(function() {
		    var name = $("input#worker-name").val().replace(/ /g, "_");
		    //Prevent duplicates
		    if (!find(workerList, name)) {
		      createWorker(name);
		    }
		});

		$("button#choose-worker").click(function() {
		  //Get data
		  var timeslotName = $("#timeslot-info-name").text();
		  var workerName = $("#timeslot-info-select option:selected").val();
		  //Find them in their arrays
		  var timeslot = find(timeslotList, timeslotName);
		  var worker = find(workerList, workerName);
		  var oldFinalWorker = timeslot.getFinalWorker();
		  //Set objects
		  if (workerName != "none") {
		    if (worker.finalTimeslot) {
		      worker.finalTimeslot.finalWorker = null;
		      worker.finalTimeslot = null;
		    }
		    worker.setIsFinal(true);
		    worker.finalTimeslot = timeslot;
		    if (oldFinalWorker) {
		      oldFinalWorker.finalTimeslot = null;
		      oldFinalWorker.setIsFinal(false);
		    }
		    timeslot.setFinalWorker(worker);
		  } else {
		    if (oldFinalWorker) {
		      oldFinalWorker.setIsFinal(false);
		    }
		    if (worker.finalTimeslot) {
		      worker.finalTimeslot.finalWorker = null;
		      worker.finalTimeslot = null;
		    }
		    worker.setIsFinal(false);
		    timeslot.setFinalWorker(null);
		  }
		  //Update table
		  update();
		});

		$(document).on('click', '.ui-droppable > button.close', function() {
		    //Delete timeslot
		    var name = $(this).parent().attr('id');
		    for (var i = 0; i < timeslotList.length; i++) {
			if (timeslotList[i].name == name) {
			  if (timeslotList.finalWorker) {
			    timeslotList[i].finalWorker.isFinal = false;
			    timeslotList[i].finalWorker.finalTimeslot = null;
			  }
			  timeslotList.remove(i);
			}
		    }
		    $(this).parent().remove(); 
		    //Update table
		    update();
		});

		$(document).on('click', 'span.label > button.close', function() {
		  //Delete Worker
		  var workerName = $(this).parent().text().trim().substring(1);
		  var worker = find(workerList, workerName);
		  if (worker.isFinal) {
		    worker.finalTimeslot.finalWorker = null;
		  }
		  //Iterate through timeslots
		  //If possible worker, delete
		  $.each(timeslotList, function(index, timeslot) {
		    timeslot.removePossibleWorker(worker);
		  });
		  $(this).parent().remove();
		  var i = workerList.indexOf(worker);
		  workerList.remove(i);
		  update();
		});

	    });

	    /** Functions **/

	    function update() {
	      //updates the table with timeslot/worker info
	      $.each(timeslotList, function(index, timeslot) {
		var tdiv = $("div#" + timeslot.name);
		var workersDiv = $(tdiv).find('div.workers');
		//Clear out worker div
		$(workersDiv).empty();
		var workers = timeslot.possibleWorkers;
		$.each(workers, function(index, worker) {
		  var workStatus;
		  if (timeslot.finalWorker && timeslot.finalWorker.name == worker.name) {
		    workStatus = "final";
		  } else if (worker.isFinal || timeslot.finalWorker) {
		    workStatus = "unavailable";
		  } else {
		    workStatus = "available";
		  }
		  $(workersDiv).append(
		    "<span class='" + workStatus + " " + worker.name + "'>" + worker.name + " </span>");
		});
	      });
	      console.log(timeslotList);
	      console.log(workerList);
	    }

	    function addAll() {
	      $.each(timeslotList, function(index, timeslot) {
		$.each(workerList, function(index, worker) {
		  timeslot.addPossibleWorker(worker);
		});
	      });
	      update();
	    }

	    function find(list, name) {
	      for (var i = 0; i < list.length; i++) {
		if (name == list[i].name) {
		  return list[i];
		}
	      }
	      return null;
	    }

	    function createWorker(name) {
	      workerList.push(new Worker(name));
	      var workerAlert = "<span class='label'><button type='button' class='close'>&times;</button>" + name + "&nbsp;</span>";
	      var clone = $(workerAlert).clone();
	      $(clone).draggable({
		  revert: true,
		  cursor: "move"
	      });
	      $("#workerDiv").append(clone);
	    }

	    function createTimeslot(time, day, name) {
		var t = new Timeslot(time, day, name);
		timeslotList.push(t);
		var timeslotDiv = "<div id='" + name + "' class='alert'><button type='button' class='close'>&times;</button><a onclick='timeslotInfo(this)'>" + name + "</a><div class='workers'></div></div>";
		var clone = $(timeslotDiv).clone();
		$(clone).droppable({
		    hoverClass: "alert-success",
		    drop: function(event, ui) {
			var name = $(ui.draggable).text().trim().substring(1);
			var exists = $(this).find("div.workers > span." + name).length;
			if (!exists) {
			  $(this).find("div.workers").append("<span class='available " + name + "'>" + name + " </span>");
			  var index = timeslotList.indexOf(t);
			  timeslotList[index].addPossibleWorker(name);
			}
		      }
		});
		$("table#schedule tbody tr#" + time).find("#" + day).append(clone);
	    }

	    function timeslotInfo(link) {
		//Show timeslot info
		var div = $(link).parent();
		//Empty the select
		$("#timeslot-info-select").empty();
		//Add 'None' option 
		$('#timeslot-info-select').append("<option value='none'>--None--</option>");
		$.each($(div).find('span'), function() {
		    $("#timeslot-info-select").append("<option value='" + $(this).text().trim() + "'>" + $(this).text().trim() + "</option>");
		});
		var timeslotName = $(div).find('a').text();
		var timeslot = find(timeslotList, timeslotName);
		if (timeslot.getFinalWorker() == null) {
		  $("#timeslot-info-select").val('none');
		} else {
		  $("#timeslot-info-select").val(timeslot.getFinalWorker().name);
		}
		$("#timeslot-info-name").text(timeslotName);
		//Show info div
		$("#timeslot-info").collapse('show');
	    }

	</script>
    </body>
</html>
